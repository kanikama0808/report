<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>法人活動（閲覧）</title>
  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --soft:#f1f5f9; --blue:#2563eb; --radius:14px; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;overflow-x:hidden;}
    body{font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:#0b1220;color:var(--ink);}
    .app{width:100%;background:#fff;border-radius:var(--radius);overflow:hidden;border:1px solid rgba(255,255,255,.15);}
    .top{background:linear-gradient(90deg,#0f172a,#101c38);color:#fff;padding:14px 16px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .badge{display:flex;gap:10px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);font-weight:900;font-size:12px;white-space:nowrap;}
    .wrap{padding:16px;background:linear-gradient(180deg,#fff,#f8fafc);display:grid;gap:14px;}
    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:14px;}

    .summaryBox{border:1px solid var(--line);border-radius:14px;padding:12px;}
    .summaryBox .cap{font-size:12px;font-weight:900;margin:0 0 10px 0;color:var(--muted);}
    .summaryBox.month{background:#eff6ff;border-color:#bfdbfe;}
    .summaryBox.cum{background:#ecfdf5;border-color:#bbf7d0;}
    .kpiGrid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px;align-items:stretch;}
    .mini{border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:linear-gradient(180deg,#fff,#f8fafc);min-width:0;}
    .mini .t{font-size:11px;font-weight:900;color:var(--muted);line-height:1.25;word-break:break-word;}
    .mini .v{margin-top:8px;font-size:20px;font-weight:900;letter-spacing:.2px;}

    table{width:100%;border-collapse:collapse;table-layout:fixed;}
    th,td{border:1px solid var(--line);padding:6px;font-size:12px;vertical-align:top;word-break:break-word;}
    th{background:#0f172a;color:#fff;text-align:left;white-space:nowrap;font-weight:900;}
    .muted{color:var(--muted);font-size:12px}
    code{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:8px;padding:2px 6px;}
    .note{margin-top:8px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<div class="app">
  <div class="top">
    <div>
      <b>BUSINESS MONTHLY REPORT</b><br/>
      <span style="opacity:.9;font-size:12px;font-weight:900;">法人活動</span>
      <span id="monthLabel" style="opacity:.85;font-size:12px;margin-left:8px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);">—</span>
    </div>
    <div class="badge">
      <span>閲覧専用</span>
      <span id="genLabel" style="opacity:.85;">—</span>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="summaryBox month">
        <div class="cap">当月サマリー</div>
        <div class="kpiGrid">
          <div class="mini"><div class="t">法人来場（提携合計）</div><div class="v" id="s_cv">—</div></div>
          <div class="mini"><div class="t">法人契約（提携合計）</div><div class="v" id="s_cc">—</div></div>
          <div class="mini"><div class="t">PR費用 合計</div><div class="v" id="s_cost">—</div></div>
          <div class="mini"><div class="t">来場CPA（合計）</div><div class="v" id="s_cpa">—</div></div>
          <div class="mini"><div class="t">契約単価（合計）</div><div class="v" id="s_cpp">—</div></div>
        </div>
        <div class="note" id="costNote" style="display:none;">※このJSONに費用項目（cost）が無いため、費用系KPIは0表示です。</div>
      </div>

      <div class="summaryBox cum" style="margin-top:12px;">
        <div class="cap">累計（〜当月）</div>
        <div class="kpiGrid">
          <div class="mini"><div class="t">法人来場（累計）</div><div class="v" id="c_cv">—</div></div>
          <div class="mini"><div class="t">法人契約（累計）</div><div class="v" id="c_cc">—</div></div>
          <div class="mini"><div class="t">PR費用（累計）</div><div class="v" id="c_cost">—</div></div>
          <div class="mini"><div class="t">来場CPA（累計）</div><div class="v" id="c_cpa">—</div></div>
          <div class="mini"><div class="t">契約単価（累計）</div><div class="v" id="c_cpp">—</div></div>
        </div>
        <div class="note" id="cumNote" style="display:none;">※累計データ（archive）が無いため、累計は当月値で代用表示しています。</div>
      </div>

      <div class="muted" style="margin-top:8px;">読み込み元：<code id="srcLabel">—</code></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px 0;">現提携（活動・PR・単価）</h3>
      <table>
        <colgroup>
          <col style="width:32%"><col style="width:9%"><col style="width:9%"><col style="width:28%"><col style="width:11%"><col style="width:11%">
        </colgroup>
        <thead>
          <tr><th>企業名</th><th>来場</th><th>契約</th><th>PR内容</th><th>費用</th><th>特典/手数料</th></tr>
        </thead>
        <tbody id="partnerRows"></tbody>
      </table>
    </div>

    <div class="card" id="plannedCard" style="display:none;">
      <h3 style="margin:0 0 10px 0;">法人業務提携（予定・交渉中）</h3>
      <table>
        <colgroup>
          <col style="width:30%"><col style="width:18%"><col style="width:52%">
        </colgroup>
        <thead>
          <tr><th>企業名</th><th>企業規模</th><th>提案内容 / 予定時期</th></tr>
        </thead>
        <tbody id="plannedRows"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const nf = new Intl.NumberFormat("ja-JP");
  const fmt0 = (n)=> nf.format(Number.isFinite(n)?n:0);
  const fmt1 = (n)=> (Number.isFinite(n)?n:0).toFixed(1);
  const clamp0 = (v)=> {
    const n = Number(v);
    return Number.isFinite(n) && n>0 ? n : 0;
  };
  const esc = (s)=> String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  function ymLabelFromMeta(meta){
    const iso = meta && meta.periodStart ? meta.periodStart : "";
    const p = String(iso).split("-");
    if(p.length>=2) return `${p[0]}年${p[1]}月`;
    return "—";
  }
  function ymFromMeta(meta){
    const iso = meta && meta.periodStart ? meta.periodStart : "";
    const p = String(iso).split("-");
    if(p.length>=2) return `${p[0]}-${p[1]}`;
    return "";
  }

  function sumPartners(partners){
    const list = partners || [];
    const totalCost = list.reduce((s,p)=> s + clamp0(p && p.cost), 0);
    const totalVisit = list.reduce((s,p)=> s + clamp0(p && p.visit), 0);
    const totalContract = list.reduce((s,p)=> s + clamp0(p && p.contract), 0);
    const visitCpa = totalVisit>0 ? totalCost/totalVisit : 0;
    const contractUnit = totalContract>0 ? totalCost/totalContract : 0;
    const hasAnyCostField = list.some(p => p && ("cost" in p));
    return { totalCost, totalVisit, totalContract, visitCpa, contractUnit, hasAnyCostField };
  }

  function computeCumulative(state, uptoYM){
    const arc = state && state.archive ? state.archive : null;
    if(!arc) return null;
    const keys = Object.keys(arc).filter(k => k <= uptoYM).sort();
    let cost=0, visit=0, contract=0;
    keys.forEach(k=>{
      const partners = arc[k] && arc[k].partners ? arc[k].partners : [];
      const s = sumPartners(partners);
      cost += s.totalCost; visit += s.totalVisit; contract += s.totalContract;
    });
    return {
      cost, visit, contract,
      visitCpa: visit>0 ? cost/visit : 0,
      contractUnit: contract>0 ? cost/contract : 0
    };
  }

  async function fetchFirstJson(){
    // あなたの現状に合わせて「datalatest.json」を最優先
    const candidates = [
      "datalatest.json",
      "data/latest.json",
      "latest.json",
      "2datalatest.json"
    ];
    for(const path of candidates){
      try{
        const res = await fetch(path + "?ts=" + Date.now(), { cache: "no-store" });
        if(res.ok){
          return { json: await res.json(), path };
        }
      }catch(e){ /* next */ }
    }
    throw new Error("JSONを取得できませんでした（datalatest.json などが見つかりません）");
  }

  async function main(){
    const { json: state, path } = await fetchFirstJson();
    document.getElementById("srcLabel").textContent = path;

    document.getElementById("monthLabel").textContent = ymLabelFromMeta(state.meta);
    document.getElementById("genLabel").textContent = "更新: " + new Date().toLocaleString("ja-JP");

    // 当月（提携合計）
    const month = sumPartners(state.partners || []);
    document.getElementById("s_cv").textContent   = fmt0(month.totalVisit);
    document.getElementById("s_cc").textContent   = fmt0(month.totalContract);
    document.getElementById("s_cost").textContent = fmt0(month.totalCost);
    document.getElementById("s_cpa").textContent  = fmt1(month.visitCpa);
    document.getElementById("s_cpp").textContent  = fmt1(month.contractUnit);

    // cost項目がそもそも無い場合の注意
    if(!month.hasAnyCostField){
      document.getElementById("costNote").style.display = "block";
    }

    // 累計（archiveが無いなら当月で代用）
    const ym = ymFromMeta(state.meta);
    const cum = computeCumulative(state, ym);

    if(cum){
      document.getElementById("c_cv").textContent   = fmt0(cum.visit);
      document.getElementById("c_cc").textContent   = fmt0(cum.contract);
      document.getElementById("c_cost").textContent = fmt0(cum.cost);
      document.getElementById("c_cpa").textContent  = fmt1(cum.visitCpa);
      document.getElementById("c_cpp").textContent  = fmt1(cum.contractUnit);
    }else{
      document.getElementById("c_cv").textContent   = fmt0(month.totalVisit);
      document.getElementById("c_cc").textContent   = fmt0(month.totalContract);
      document.getElementById("c_cost").textContent = fmt0(month.totalCost);
      document.getElementById("c_cpa").textContent  = fmt1(month.visitCpa);
      document.getElementById("c_cpp").textContent  = fmt1(month.contractUnit);
      document.getElementById("cumNote").style.display = "block";
    }

    // 現提携テーブル
    const pb = document.getElementById("partnerRows");
    pb.innerHTML = "";
    (state.partners || []).forEach(p=>{
      const benefit = clamp0(p && p.benefit);
      const fee = clamp0(p && p.fee);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(p && p.name || "")}</td>
        <td style="text-align:right;">${fmt0(clamp0(p && p.visit))}</td>
        <td style="text-align:right;">${fmt0(clamp0(p && p.contract))}</td>
        <td>${esc(p && p.pr || "")}</td>
        <td style="text-align:right;">${fmt0(clamp0(p && p.cost))}</td>
        <td>${benefit?("特典:"+fmt0(benefit)):""}${(benefit&&fee)?" / ":""}${fee?("手数料:"+fmt0(fee)):""}</td>
      `;
      pb.appendChild(tr);
    });

    // planned があれば表示（あなたのJSONには今は無いので非表示のまま）
    if(Array.isArray(state.planned) && state.planned.length){
      document.getElementById("plannedCard").style.display = "block";
      const plb = document.getElementById("plannedRows");
      plb.innerHTML = "";
      state.planned.forEach(p=>{
        const tail = [p.proposal||"", p.schedule?("予定:"+p.schedule):""].filter(Boolean).join(" / ");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(p.name||"")}</td>
          <td>${esc(p.companySize||"")}</td>
          <td>${esc(tail)}</td>
        `;
        plb.appendChild(tr);
      });
    }
  }

  main().catch(err=>{
    alert("表示に失敗しました： " + err.message);
    console.error(err);
  });
</script>
</body>
</html>
